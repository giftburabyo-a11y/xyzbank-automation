name: XYZ Bank Selenium Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  selenium-tests:
    name: Run XYZ Bank Selenium Tests
    runs-on: ubuntu-latest

    steps:

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # ubuntu-latest ships with Chrome pre-installed.
      # WebDriverManager in DriverManager.java auto-downloads the matching ChromeDriver.
      # No manual installation needed.
      - name: Confirm Chrome version
        run: google-chrome --version

      # headless=true is read by DriverManager to add --headless to ChromeOptions
      # maven.test.failure.ignore=true keeps the build GREEN even when tests fail
      - name: Run Selenium tests (headless)
        id: run-tests
        run: |
          mvn test \
            -Dheadless=true \
            -Dmaven.test.failure.ignore=true \
            --batch-mode \
            --no-transfer-progress

      # Confirm surefire XML reports were generated
      - name: Debug surefire reports
        if: always()
        run: |
          echo "=== Surefire report files ==="
          find . -name "TEST-*.xml" 2>/dev/null || echo "NO XML FILES FOUND"
          echo "=== Surefire directory ==="
          ls -la target/surefire-reports/ 2>/dev/null || echo "NO SUREFIRE DIR"

      - name: Parse test results
        if: always()
        id: parse-results
        run: |
          TOTAL=0; PASSED=0; FAILED=0; SKIPPED=0; ERRORS=0
          for f in target/surefire-reports/TEST-*.xml; do
            [ -f "$f" ] || continue
            t=$(grep  -oP 'tests="\K[0-9]+'    "$f" | head -1)
            fa=$(grep -oP 'failures="\K[0-9]+' "$f" | head -1)
            sk=$(grep -oP 'skipped="\K[0-9]+'  "$f" | head -1)
            er=$(grep -oP 'errors="\K[0-9]+'   "$f" | head -1)
            TOTAL=$((TOTAL   + ${t:-0}))
            FAILED=$((FAILED  + ${fa:-0}))
            SKIPPED=$((SKIPPED + ${sk:-0}))
            ERRORS=$((ERRORS  + ${er:-0}))
          done
          PASSED=$((TOTAL - FAILED - SKIPPED - ERRORS))
          [ "$TOTAL" -gt 0 ] && PASS_PCT=$((PASSED * 100 / TOTAL)) || PASS_PCT=0

          FAILURES_HTML=""
          for f in target/surefire-reports/TEST-*.xml; do
            [ -f "$f" ] || continue
            while IFS='|' read -r cls nm msg; do
              FAILURES_HTML+="<tr>"
              FAILURES_HTML+="<td style='padding:8px 12px;border-bottom:1px solid #eee;font-family:monospace;font-size:12px;color:#b71c1c'>${cls}</td>"
              FAILURES_HTML+="<td style='padding:8px 12px;border-bottom:1px solid #eee;font-size:13px'>${nm}</td>"
              FAILURES_HTML+="<td style='padding:8px 12px;border-bottom:1px solid #eee;font-size:12px;color:#555'>${msg}</td>"
              FAILURES_HTML+="</tr>"
            done < <(python3 - "$f" <<'PYEOF'
          import sys, xml.etree.ElementTree as ET
          tree = ET.parse(sys.argv[1])
          for tc in tree.findall('.//testcase'):
              node = tc.find('failure') or tc.find('error')
              if node is None: continue
              msg = ((node.get('message') or node.text or '').strip())[:280]
              print(f"{tc.get('classname','')}|{tc.get('name','')}|{msg}")
          PYEOF
            )
          done

          echo "total=$TOTAL"       >> $GITHUB_OUTPUT
          echo "passed=$PASSED"     >> $GITHUB_OUTPUT
          echo "failed=$FAILED"     >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED"   >> $GITHUB_OUTPUT
          echo "errors=$ERRORS"     >> $GITHUB_OUTPUT
          echo "pass_pct=$PASS_PCT" >> $GITHUB_OUTPUT
          {
            echo "failures_html<<HTMLEOF"
            printf '%s' "$FAILURES_HTML"
            echo ""
            echo "HTMLEOF"
          } >> $GITHUB_OUTPUT

      - name: Publish Test Results (GitHub Check)
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: target/surefire-reports/**/*.xml
          check_name: "XYZ Bank Selenium Test Results"
          comment_on_pr: true
          fail_on: "nothing"

      - name: Generate Allure Report
        if: always()
        run: mvn allure:report --no-transfer-progress

      - name: Upload Allure Report artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-report-${{ github.run_number }}
          path: target/site/allure-maven-plugin/
          retention-days: 14

      - name: Upload Surefire XML reports artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: surefire-reports-${{ github.run_number }}
          path: target/surefire-reports/
          retention-days: 14

      # â”€â”€ Email report â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Send email report
        if: always()
        env:
          GMAIL_ADDRESS:  ${{ secrets.GMAIL_ADDRESS }}
          GMAIL_APP_PASS: ${{ secrets.GMAIL_APP_PASS }}
          REPORT_TO:      ${{ secrets.REPORT_EMAIL }}
        run: |
          python3 << 'PYEOF'
          import os, smtplib, json, glob
          from email.mime.multipart import MIMEMultipart
          from email.mime.text import MIMEText
          from datetime import datetime, timezone

          gmail_user = os.environ.get("GMAIL_ADDRESS", "")
          gmail_pass = os.environ.get("GMAIL_APP_PASS", "")
          report_to  = os.environ.get("REPORT_TO", "")
          if not all([gmail_user, gmail_pass, report_to]):
              print("Email secrets not configured â€” skipping")
              exit(0)

          total    = "${{ steps.parse-results.outputs.total }}"    or "0"
          passed   = "${{ steps.parse-results.outputs.passed }}"   or "0"
          failed   = "${{ steps.parse-results.outputs.failed }}"   or "0"
          skipped  = "${{ steps.parse-results.outputs.skipped }}"  or "0"
          errors   = "${{ steps.parse-results.outputs.errors }}"   or "0"
          pass_pct = "${{ steps.parse-results.outputs.pass_pct }}" or "0"

          # Parse Allure JSON for rich failure details
          failing_tests = []
          for json_file in sorted(glob.glob("target/allure-results/*-result.json")):
              try:
                  with open(json_file, 'r', encoding='utf-8') as f:
                      data = json.load(f)
              except: continue
              if data.get("status") not in ["failed", "broken"]: continue
              labels     = {l["name"]: l["value"] for l in data.get("labels", [])}
              test_class = labels.get("testClass", "").split(".")[-1] or "Unknown"
              steps_list = [f"{i}. {s.get('name','Step')}" for i, s in enumerate(data.get("steps", []), 1)]
              steps_str  = "<br>".join(steps_list) if steps_list else "See Allure report for trace."
              desc       = (data.get("description") or "No description.").replace("\n", "<br>")
              severity   = labels.get("severity", "normal").capitalize()
              msg        = data.get("statusDetails", {}).get("message", "No assertion message.")
              failing_tests.append({
                  "name": data.get("name", "Unknown Test"),
                  "class": test_class, "desc": desc,
                  "steps": steps_str, "severity": severity, "message": msg
              })

          # is_pass only if no failures AND no errors
          is_pass   = int(failed) == 0 and int(errors) == 0
          status    = "PASSED"  if is_pass else "FAILED"
          s_icon    = "âœ…"       if is_pass else "âŒ"
          s_color   = "#2e7d32" if is_pass else "#b71c1c"
          s_bg      = "#e8f5e9" if is_pass else "#ffebee"
          timestamp = datetime.now(timezone.utc).strftime("%d %B %Y at %H:%M UTC")
          run_url   = "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          branch    = "${{ github.ref_name }}"
          short_sha = "${{ github.sha }}"[:7]
          commit_url= "${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
          run_num   = "${{ github.run_number }}"
          actor     = "${{ github.actor }}"
          event     = "${{ github.event_name }}"
          trigger   = {"push":"Push to branch","pull_request":"Pull Request","workflow_dispatch":"Manual trigger"}.get(event, event)

          next_steps = (
              "All tests passed. The XYZ Bank application is stable. No action required."
              if is_pass else
              "<strong>Action required.</strong> One or more tests failed. "
              "Review the detailed failure report below and download the Allure artifact from GitHub."
          )

          # Build failure blocks
          fail_block = ""
          if failing_tests:
              fail_block = '<h2 style="margin:32px 0 12px;font-size:18px;color:#b71c1c">Detailed Failure Report</h2>'
              for t in failing_tests:
                  fail_block += f"""
                  <div style="border:1px solid #ffcdd2;border-radius:8px;margin-bottom:20px;overflow:hidden;background:#fff">
                    <div style="background:#ffebee;padding:12px 16px;border-bottom:1px solid #ffcdd2">
                      <p style="margin:0;font-size:14px;font-weight:700;color:#b71c1c">{t['name']}</p>
                      <p style="margin:2px 0 0;font-size:11px;color:#666">{t['class']} &nbsp;|&nbsp; Severity: {t['severity']}</p>
                    </div>
                    <div style="padding:16px;font-size:13px;line-height:1.6;color:#333">
                      <p style="margin:0 0 10px"><strong>Description:</strong><br>{t['desc']}</p>
                      <p style="margin:0 0 10px"><strong>Steps to Reproduce:</strong><br><span style="color:#555">{t['steps']}</span></p>
                      <div style="background:#f8f9fa;padding:12px;border-radius:4px;font-family:monospace;font-size:12px;border-left:4px solid #b71c1c;color:#c62828">{t['message']}</div>
                    </div>
                  </div>"""

          html = f"""<!DOCTYPE html><html lang="en">
          <head><meta charset="UTF-8"></head>
          <body style="margin:0;padding:0;background:#f4f6f9;font-family:Arial,sans-serif">
          <table width="100%" cellpadding="0" cellspacing="0" style="background:#f4f6f9;padding:32px 0">
          <tr><td align="center">
          <table width="620" cellpadding="0" cellspacing="0" style="max-width:620px;width:100%">
            <tr><td style="background:#1a237e;border-radius:10px 10px 0 0;padding:28px 36px">
              <p style="margin:0;font-size:11px;color:#9fa8da;letter-spacing:1px;text-transform:uppercase">Automated Test Report</p>
              <h1 style="margin:6px 0 0;font-size:24px;color:#fff;font-weight:700">XYZ Bank CI Pipeline</h1>
              <p style="margin:6px 0 0;font-size:12px;color:#9fa8da">${{ github.repository }} &middot; Run #{run_num}</p>
            </td></tr>
            <tr><td style="background:{s_bg};padding:20px 36px;border-left:5px solid {s_color}">
              <p style="margin:0;font-size:20px;font-weight:700;color:{s_color}">{s_icon} Build {status}</p>
              <p style="margin:6px 0 0;font-size:12px;color:#555">Completed on {timestamp}</p>
            </td></tr>
            <tr><td style="background:#fff;padding:28px 36px">
              <h2 style="margin:0 0 14px;font-size:17px;color:#1a237e">Run Details</h2>
              <table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid #e8eaf0;border-radius:8px;font-size:13px;margin-bottom:28px">
                <tr style="background:#f5f7ff">
                  <td style="padding:9px 14px;font-weight:700;color:#3949ab;border-bottom:1px solid #e8eaf0;width:38%">Field</td>
                  <td style="padding:9px 14px;font-weight:700;color:#3949ab;border-bottom:1px solid #e8eaf0">Value</td>
                </tr>
                <tr><td style="padding:9px 14px;color:#555;border-bottom:1px solid #f0f0f0;font-weight:600">Repository</td><td style="padding:9px 14px;border-bottom:1px solid #f0f0f0">${{ github.repository }}</td></tr>
                <tr style="background:#fafafa"><td style="padding:9px 14px;color:#555;border-bottom:1px solid #f0f0f0;font-weight:600">Branch</td><td style="padding:9px 14px;border-bottom:1px solid #f0f0f0">{branch}</td></tr>
                <tr><td style="padding:9px 14px;color:#555;border-bottom:1px solid #f0f0f0;font-weight:600">Commit</td><td style="padding:9px 14px;border-bottom:1px solid #f0f0f0"><a href="{commit_url}" style="color:#1a237e">{short_sha}</a> &mdash; ${{ github.event.head_commit.message }}</td></tr>
                <tr style="background:#fafafa"><td style="padding:9px 14px;color:#555;border-bottom:1px solid #f0f0f0;font-weight:600">Triggered by</td><td style="padding:9px 14px;border-bottom:1px solid #f0f0f0">{actor} ({trigger})</td></tr>
                <tr><td style="padding:9px 14px;color:#555;font-weight:600">Environment</td><td style="padding:9px 14px">ubuntu-latest &middot; Java 21 &middot; Headless Chrome &middot; Allure</td></tr>
              </table>

              <h2 style="margin:0 0 14px;font-size:17px;color:#1a237e">Test Summary</h2>
              <table width="100%" cellpadding="6" cellspacing="6" style="margin-bottom:12px">
                <tr>
                  <td style="background:#e8f5e9;border-radius:8px;padding:14px;text-align:center"><p style="margin:0;font-size:26px;font-weight:700;color:#2e7d32">{passed}</p><p style="margin:4px 0 0;font-size:11px;color:#555;text-transform:uppercase">Passed</p></td>
                  <td style="background:#ffebee;border-radius:8px;padding:14px;text-align:center"><p style="margin:0;font-size:26px;font-weight:700;color:#b71c1c">{failed}</p><p style="margin:4px 0 0;font-size:11px;color:#555;text-transform:uppercase">Failed</p></td>
                  <td style="background:#fff8e1;border-radius:8px;padding:14px;text-align:center"><p style="margin:0;font-size:26px;font-weight:700;color:#f57f17">{skipped}</p><p style="margin:4px 0 0;font-size:11px;color:#555;text-transform:uppercase">Skipped</p></td>
                  <td style="background:#f5f5f5;border-radius:8px;padding:14px;text-align:center"><p style="margin:0;font-size:26px;font-weight:700;color:#333">{total}</p><p style="margin:4px 0 0;font-size:11px;color:#555;text-transform:uppercase">Total</p></td>
                </tr>
              </table>
              <p style="margin:4px 0 6px;font-size:13px;color:#555">Pass rate: <strong>{pass_pct}%</strong></p>
              <div style="background:#e0e0e0;border-radius:99px;height:10px;margin-bottom:28px">
                <div style="background:{s_color};width:{pass_pct}%;height:10px;border-radius:99px;min-width:4px"></div>
              </div>

              {fail_block}

              <h2 style="margin:32px 0 12px;font-size:17px;color:#1a237e">Next Steps</h2>
              <div style="background:#f5f7ff;border-radius:8px;padding:16px 20px;font-size:13px;color:#333;line-height:1.8">{next_steps}</div>
              <div style="text-align:center;margin-top:32px">
                <a href="{run_url}" style="display:inline-block;background:#1a237e;color:#fff;text-decoration:none;padding:14px 28px;border-radius:6px;font-size:14px;font-weight:700;margin:5px">View Run on GitHub &rarr;</a>
                <a href="{run_url}#artifacts" style="display:inline-block;background:#3949ab;color:#fff;text-decoration:none;padding:14px 28px;border-radius:6px;font-size:14px;font-weight:700;margin:5px">Download Allure Report &darr;</a>
              </div>
            </td></tr>
            <tr><td style="background:#f5f7ff;border-radius:0 0 10px 10px;padding:16px 36px;text-align:center;border-top:1px solid #e8eaf0">
              <p style="margin:0;font-size:11px;color:#9e9e9e">Generated automatically by XYZ Bank CI pipeline &middot; <a href="${{ github.server_url }}/${{ github.repository }}" style="color:#3949ab">${{ github.repository }}</a></p>
            </td></tr>
          </table></td></tr></table>
          </body></html>"""

          subject = f"{s_icon} [Run #{run_num}] XYZ Bank Tests {status} â€” {branch}"
          msg = MIMEMultipart("alternative")
          msg["Subject"] = subject
          msg["From"]    = f"XYZ Bank CI <{gmail_user}>"
          msg["To"]      = report_to
          msg.attach(MIMEText(html, "html"))
          with smtplib.SMTP_SSL("smtp.gmail.com", 465) as server:
              server.login(gmail_user, gmail_pass)
              server.sendmail(gmail_user, report_to, msg.as_string())
          print(f"Email sent to {report_to} â€” {len(failing_tests)} failure block(s).")
          PYEOF

      # â”€â”€ Slack report â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Send Slack report
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          python3 << 'PYEOF'
          import json, os, subprocess, sys, glob

          webhook = os.environ.get("SLACK_WEBHOOK_URL", "")
          if not webhook:
              print("No SLACK_WEBHOOK_URL â€” skipping")
              sys.exit(0)

          total    = "${{ steps.parse-results.outputs.total }}"    or "0"
          passed   = "${{ steps.parse-results.outputs.passed }}"   or "0"
          failed   = "${{ steps.parse-results.outputs.failed }}"   or "0"
          skipped  = "${{ steps.parse-results.outputs.skipped }}"  or "0"
          errors   = "${{ steps.parse-results.outputs.errors }}"   or "0"
          pass_pct = "${{ steps.parse-results.outputs.pass_pct }}" or "0"
          is_pass  = int(failed) == 0 and int(errors) == 0
          repo     = "${{ github.repository }}"
          branch   = "${{ github.ref_name }}"
          actor    = "${{ github.actor }}"
          run_num  = "${{ github.run_number }}"
          run_url  = "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          sha      = "${{ github.sha }}"[:7]
          commit_msg = "${{ github.event.head_commit.message }}"
          event    = "${{ github.event_name }}"
          trigger  = {"push":"Push to branch","pull_request":"Pull Request","workflow_dispatch":"Manual trigger"}.get(event, event)

          # Parse Allure JSON for failing tests
          failing_tests = []
          for json_file in sorted(glob.glob("target/allure-results/*-result.json")):
              try:
                  with open(json_file, 'r', encoding='utf-8') as f:
                      data = json.load(f)
              except: continue
              if data.get("status") not in ["failed", "broken"]: continue
              labels     = {l["name"]: l["value"] for l in data.get("labels", [])}
              test_class = labels.get("testClass", "").split(".")[-1] or "Unknown"
              steps_list = [f"{i}. {s.get('name','Step')}" for i, s in enumerate(data.get("steps",[]),1)]
              steps_str  = "\n".join(steps_list) if steps_list else "See Allure report."
              desc       = (data.get("description") or "No description.").strip()
              severity   = labels.get("severity", "normal").capitalize()
              priority   = "High" if severity in ["Blocker","Critical"] else ("Medium" if severity=="Normal" else "Low")
              msg        = data.get("statusDetails", {}).get("message", "No assertion message.")
              has_ss     = any("screenshot" in a.get("name","").lower() for a in data.get("attachments",[]))
              failing_tests.append({
                  "name": data.get("name","Unknown"), "class": test_class,
                  "desc": desc, "steps": steps_str, "severity": severity,
                  "priority": priority, "message": msg,
                  "screenshot": "ğŸ“¸ Screenshot captured â€” see Allure artifact." if has_ss else "No screenshot."
              })

          s_emoji = "âœ…" if is_pass else "âŒ"
          s_label = "PASSED" if is_pass else "FAILED"
          color   = "#2e7d32" if is_pass else "#e01e5a"

          failure_blocks = []
          for i, t in enumerate(failing_tests, 1):
              failure_blocks.append({
                  "type": "section",
                  "text": {"type": "mrkdwn", "text": (
                      f"*Test {i}:* `{t['name']}`\n"
                      f"*Class:* `{t['class']}` | *Severity:* {t['severity']} | *Priority:* {t['priority']}\n\n"
                      f"*Description*\n{t['desc']}\n\n"
                      f"*Steps to Reproduce*\n{t['steps']}\n\n"
                      f"*Assertion Failure*\n```{t['message'][:300]}```\n"
                      f"{t['screenshot']}"
                  )}
              })
              if i < len(failing_tests):
                  failure_blocks.append({"type": "divider"})

          blocks = [
              {"type": "header", "text": {"type": "plain_text", "text": f"{s_emoji}  XYZ Bank CI â€” Tests {s_label}", "emoji": True}},
              {"type": "divider"},
              {"type": "section", "fields": [
                  {"type": "mrkdwn", "text": f"*Repository*\n{repo}"},
                  {"type": "mrkdwn", "text": f"*Branch*\n{branch}"},
                  {"type": "mrkdwn", "text": f"*Triggered by*\n{actor} ({trigger})"},
                  {"type": "mrkdwn", "text": f"*Commit*\n`{sha}` â€” {commit_msg[:60]}"},
                  {"type": "mrkdwn", "text": f"*Run*\n<{run_url}|Run #{run_num}>"},
                  {"type": "mrkdwn", "text": f"*Environment*\nubuntu-latest Â· Java 21 Â· Headless Chrome"},
              ]},
              {"type": "section", "text": {"type": "mrkdwn", "text": (
                  f"*Test Summary*\n"
                  f"âœ… Passed: *{passed}*   âŒ Failed: *{failed}*   "
                  f"â­ Skipped: *{skipped}*   ğŸ“Š Total: *{total}*   ğŸ“ˆ Pass rate: *{pass_pct}%*"
              )}},
          ]

          if failing_tests:
              blocks += [
                  {"type": "divider"},
                  {"type": "section", "text": {"type": "mrkdwn", "text": f":rotating_light: *{len(failing_tests)} Failing Test(s) â€” Detailed Report*"}},
                  {"type": "divider"},
              ] + failure_blocks
          else:
              blocks.append({"type": "section", "text": {"type": "mrkdwn", "text": ":white_check_mark: All tests passed. No failures to report."}})

          blocks += [
              {"type": "divider"},
              {"type": "actions", "elements": [{"type": "button", "text": {"type": "plain_text", "text": "View Full Run on GitHub", "emoji": True}, "url": run_url, "style": "primary"}]}
          ]

          payload = {
              "text": f"{s_emoji} XYZ Bank Tests {s_label} â€” Run #{run_num}",
              "attachments": [{"color": color, "blocks": blocks}]
          }
          result = subprocess.run(
              ["curl", "-s", "-X", "POST", webhook, "-H", "Content-Type: application/json", "-d", json.dumps(payload)],
              capture_output=True, text=True
          )
          print(result.stdout)
          print(f"Slack sent â€” {len(failing_tests)} failure(s) detailed.")
          PYEOF

      - name: Summary
        if: always()
        run: |
          echo "## XYZ Bank Test Results" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total  | ${{ steps.parse-results.outputs.total }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Passed | ${{ steps.parse-results.outputs.passed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Failed | ${{ steps.parse-results.outputs.failed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Errors | ${{ steps.parse-results.outputs.errors }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Skipped| ${{ steps.parse-results.outputs.skipped }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Pass % | ${{ steps.parse-results.outputs.pass_pct }}% |" >> $GITHUB_STEP_SUMMARY