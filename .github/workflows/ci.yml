name: Newsletter Selenium Tests

# ‚îÄ‚îÄ Triggers
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# ‚îÄ‚îÄ Permissions
permissions:
  contents: read
  checks: write
  pull-requests: write

# ‚îÄ‚îÄ Jobs
jobs:
  selenium-tests:
    name: Run Selenium Tests (JUnit 5)
    runs-on: ubuntu-latest

    steps:

      # 1. Check out the repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Set up Java 21
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      # 3. Cache Maven dependencies
      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      # 4. Run tests in headless mode with the 'ci' Maven profile
      - name: Run Selenium tests (headless)
        id: run-tests
        run: |
          mvn test -P ci \
            -Dheadless=true \
            -Dbase.url=https://bayingana.github.io/NEWSLETTER/ \
            -Dmaven.test.failure.ignore=true \
            --batch-mode \
            --no-transfer-progress
        env:
          DISPLAY: :99

      # 5. Parse surefire XML and expose counts + failure details
      - name: Parse test results
        if: always()
        id: parse-results
        run: |
          TOTAL=0; PASSED=0; FAILED=0; SKIPPED=0; ERRORS=0
          for f in target/surefire-reports/TEST-*.xml; do
            [ -f "$f" ] || continue
            t=$(grep  -oP 'tests="\K[0-9]+'    "$f" | head -1)
            fa=$(grep -oP 'failures="\K[0-9]+' "$f" | head -1)
            sk=$(grep -oP 'skipped="\K[0-9]+'  "$f" | head -1)
            er=$(grep -oP 'errors="\K[0-9]+'   "$f" | head -1)
            TOTAL=$((TOTAL   + ${t:-0}))
            FAILED=$((FAILED  + ${fa:-0}))
            SKIPPED=$((SKIPPED + ${sk:-0}))
            ERRORS=$((ERRORS  + ${er:-0}))
          done
          PASSED=$((TOTAL - FAILED - SKIPPED - ERRORS))
          [ "$TOTAL" -gt 0 ] && PASS_PCT=$((PASSED * 100 / TOTAL)) || PASS_PCT=0
          # Build HTML rows for failed tests
          FAILURES_HTML=""
          for f in target/surefire-reports/TEST-*.xml; do
            [ -f "$f" ] || continue
            while IFS='|' read -r cls nm msg; do
              FAILURES_HTML+="<tr>"
              FAILURES_HTML+="<td style='padding:8px 12px;border-bottom:1px solid #eee;font-family:monospace;font-size:12px;color:#b71c1c'>${cls}</td>"
              FAILURES_HTML+="<td style='padding:8px 12px;border-bottom:1px solid #eee;font-size:13px'>${nm}</td>"
              FAILURES_HTML+="<td style='padding:8px 12px;border-bottom:1px solid #eee;font-size:12px;color:#555'>${msg}</td>"
              FAILURES_HTML+="</tr>"
            done < <(python3 - "$f" <<'PYEOF'
          import sys, xml.etree.ElementTree as ET
          tree = ET.parse(sys.argv[1])
          for tc in tree.findall('.//testcase'):
              node = tc.find('failure') or tc.find('error')
              if node is None: continue
              msg = ((node.get('message') or node.text or '').strip())[:280]
              print(f"{tc.get('classname','')}|{tc.get('name','')}|{msg}")
          PYEOF
            )
          done
          echo "total=$TOTAL"     >> $GITHUB_OUTPUT
          echo "passed=$PASSED"   >> $GITHUB_OUTPUT
          echo "failed=$FAILED"   >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
          echo "errors=$ERRORS"   >> $GITHUB_OUTPUT
          echo "pass_pct=$PASS_PCT" >> $GITHUB_OUTPUT
          {
            echo "failures_html<<HTMLEOF"
            printf '%s' "$FAILURES_HTML"
            echo ""
            echo "HTMLEOF"
          } >> $GITHUB_OUTPUT
      # 6. Publish JUnit 5 test results as GitHub Check
      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: target/surefire-reports/**/*.xml
          check_name: "Selenium Test Results"
          comment_on_pr: true
          fail_on: "test failures"

      # 7. Generate Allure Report
      - name: Generate Allure Report
        run: mvn allure:report
        if: always()

      # 8. Upload Allure Report as artifact
      - name: Upload Allure Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-report
          path: target/site/allure-maven-plugin/

      # 9. Upload Surefire reports as downloadable artifact
      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: surefire-reports-${{ github.run_number }}
          path: target/surefire-reports/
          retention-days: 14

      - name: Send email report
        if: always()
        env:
          GMAIL_ADDRESS:  ${{ secrets.GMAIL_ADRESS }}
          GMAIL_APP_PASS: ${{ secrets.GMAIL_APP_PASS }}
          REPORT_TO:      ${{ secrets.REPORT_EMAIL }}
        run: |
          python3 << 'PYEOF'
          import os, smtplib, json, glob
          from email.mime.multipart import MIMEMultipart
          from email.mime.text import MIMEText
          from datetime import datetime, timezone
          gmail_user = os.environ["GMAIL_ADDRESS"]
          gmail_pass = os.environ["GMAIL_APP_PASS"]
          report_to  = os.environ["REPORT_TO"]
          total    = "${{ steps.parse-results.outputs.total }}"    or "0"
          passed   = "${{ steps.parse-results.outputs.passed }}"   or "0"
          failed   = "${{ steps.parse-results.outputs.failed }}"   or "0"
          skipped  = "${{ steps.parse-results.outputs.skipped }}"  or "0"
          pass_pct = "${{ steps.parse-results.outputs.pass_pct }}" or "0"
          
          # ‚îÄ‚îÄ Parse Allure JSON results for detailed failure info ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          failing_tests = []
          for json_file in sorted(glob.glob("target/allure-results/*-result.json")):
              try:
                  with open(json_file, 'r', encoding='utf-8') as f:
                      data = json.load(f)
              except: continue
              if data.get("status") in ["failed", "broken"]:
                  labels = {l["name"]: l["value"] for l in data.get("labels", [])}
                  test_class = labels.get("testClass", "").split(".")[-1] or "Unknown"
          
                  # Extract steps
                  steps_list = []
                  for i, s in enumerate(data.get("steps", []), 1):
                      steps_list.append(f"{i}. {s.get('name', 'Step')}")
                  steps_str = "<br>".join(steps_list) if steps_list else "1. See Allure report for full trace."
                  # Extract description and impact
                  desc_raw = data.get("description", "No description provided.")
                  desc = desc_raw
                  impact = "High: Immediate attention required."
                  if "**Impact:**" in desc_raw:
                      parts = desc_raw.split("**Impact:**")
                      desc = parts[0].strip().replace("\n", "<br>")
                      impact = parts[1].strip()
                  else:
                      desc = desc.replace("\n", "<br>")
                  severity = labels.get("severity", "normal").capitalize()
                  msg = data.get("statusDetails", {}).get("message", "No assertion message available.")
                  failing_tests.append({
                      "name":     data.get("name", "Unknown Test"),
                      "class":    test_class,
                      "desc":     desc,
                      "steps":    steps_str,
                      "impact":   impact,
                      "severity": severity,
                      "message":  msg
                  })
          outcome = "${{ steps.run-tests.outcome }}"
          is_pass = (outcome == "success" and int(failed) == 0)
          status    = "PASSED"  if is_pass else "FAILED"
          s_icon    = "‚úÖ"       if is_pass else "‚ùå"
          s_color   = "#2e7d32" if is_pass else "#b71c1c"
          s_bg      = "#e8f5e9" if is_pass else "#ffebee"
          next_steps = (
            "All tests passed. The build is stable and the newsletter feature is "
            "working as expected. No immediate action is required."
          ) if is_pass else (
            "<strong>Action required.</strong> One or more tests failed. Please review the detailed "
            "failure report below and download the Allure artifact from GitHub for visual logs."
          )
          event = "${{ github.event_name }}"
          trigger = {
            "push":               "Push to branch",
            "pull_request":       "Pull Request #${{ github.event.pull_request.number }}",
            "workflow_dispatch":  "Manual trigger",
          }.get(event, event)
          run_url    = "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          run_num    = "${{ github.run_number }}"
          branch     = "${{ github.ref_name }}"
          commit_url = "${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
          short_sha  = "${{ github.sha }}"[:7]
          timestamp  = datetime.now(timezone.utc).strftime("%d %B %Y at %H:%M UTC")
          # ‚îÄ‚îÄ Failure report block ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          fail_block = ""
          if failing_tests:
            fail_block = '<h2 style="margin:32px 0 12px;font-size:18px;color:#b71c1c">üö® Detailed Failure Report</h2>'
            for t in failing_tests:
              fail_block += f"""
              <div style="border:1px solid #ffcdd2; border-radius:8px; margin-bottom:20px; overflow:hidden; background:#fff">
                <div style="background:#ffebee; padding:12px 16px; border-bottom:1px solid #ffcdd2;">
                  <p style="margin:0; font-size:14px; font-weight:700; color:#b71c1c">{t['name']}</p>
                  <p style="margin:2px 0 0; font-size:11px; color:#666; text-transform:uppercase; letter-spacing:0.5px">{t['class']}</p>
                </div>
                <div style="padding:16px; font-size:13px; line-height:1.6; color:#333;">
                  <p style="margin:0 0 10px;"><strong>Description:</strong><br>{t['desc']}</p>
                  <p style="margin:0 0 10px;"><strong>Steps to Reproduce:</strong><br><span style="color:#555;">{t['steps']}</span></p>
                  <p style="margin:0 0 10px;"><strong>Impact:</strong> {t['impact']}</p>
                  <p style="margin:0 0 10px;"><strong>Severity:</strong> {t['severity']}</p>
                  <div style="background:#f8f9fa; padding:12px; border-radius:4px; font-family:monospace; font-size:12px; margin-top:12px; border-left:4px solid #b71c1c; color:#c62828">
                    {t['message']}
                  </div>
                </div>
              </div>"""
          html = f"""<!DOCTYPE html><html lang="en">
          <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"></head>
          <body style="margin:0;padding:0;background:#f4f6f9;font-family:Arial,Helvetica,sans-serif">
          <table width="100%" cellpadding="0" cellspacing="0" style="background:#f4f6f9;padding:32px 0">
          <tr><td align="center">
          <table width="620" cellpadding="0" cellspacing="0" style="max-width:620px;width:100%">
            <!-- Header -->
            <tr><td style="background:#1a237e;border-radius:10px 10px 0 0;padding:28px 36px">
              <p style="margin:0;font-size:11px;color:#9fa8da;letter-spacing:1px;text-transform:uppercase">Automated Test Report</p>
              <h1 style="margin:6px 0 0;font-size:24px;color:#fff;font-weight:700">Newsletter CI Pipeline</h1>
              <p style="margin:6px 0 0;font-size:12px;color:#9fa8da">${{ github.repository }} &nbsp;&middot;&nbsp; Run #${{ github.run_number }}</p>
            </td></tr>
            <!-- Status banner -->
            <tr><td style="background:{s_bg};padding:20px 36px;border-left:5px solid {s_color}">
              <p style="margin:0;font-size:20px;font-weight:700;color:{s_color}">{s_icon}&nbsp; Build {status}</p>
              <p style="margin:6px 0 0;font-size:12px;color:#555">Completed on {timestamp}</p>
            </td></tr>
            <!-- Body -->
            <tr><td style="background:#fff;padding:28px 36px">
              <!-- Run details -->
              <h2 style="margin:0 0 14px;font-size:17px;color:#1a237e">Run Details</h2>
              <table width="100%" cellpadding="0" cellspacing="0"
                     style="border:1px solid #e8eaf0;border-radius:8px;overflow:hidden;margin-bottom:28px;font-size:13px">
                <tr style="background:#f5f7ff">
                  <td style="padding:9px 14px;font-weight:700;color:#3949ab;border-bottom:1px solid #e8eaf0;width:38%">Field</td>
                  <td style="padding:9px 14px;font-weight:700;color:#3949ab;border-bottom:1px solid #e8eaf0">Value</td>
                </tr>
                <tr>
                  <td style="padding:9px 14px;color:#555;border-bottom:1px solid #f0f0f0;font-weight:600">Repository</td>
                  <td style="padding:9px 14px;color:#222;border-bottom:1px solid #f0f0f0">${{ github.repository }}</td>
                </tr>
                <tr style="background:#fafafa">
                  <td style="padding:9px 14px;color:#555;border-bottom:1px solid #f0f0f0;font-weight:600">Branch</td>
                  <td style="padding:9px 14px;color:#222;border-bottom:1px solid #f0f0f0">${{ github.ref_name }}</td>
                </tr>
                <tr>
                  <td style="padding:9px 14px;color:#555;border-bottom:1px solid #f0f0f0;font-weight:600">Commit</td>
                  <td style="padding:9px 14px;color:#222;border-bottom:1px solid #f0f0f0">
                    <a href="{commit_url}" style="color:#1a237e;text-decoration:none">{short_sha}</a>
                    &nbsp;&mdash;&nbsp;${{ github.event.head_commit.message }}
                  </td>
                </tr>
                <tr style="background:#fafafa">
                  <td style="padding:9px 14px;color:#555;border-bottom:1px solid #f0f0f0;font-weight:600">Triggered by</td>
                  <td style="padding:9px 14px;color:#222;border-bottom:1px solid #f0f0f0">${{ github.actor }} &nbsp;({trigger})</td>
                </tr>
                <tr>
                  <td style="padding:9px 14px;color:#555;font-weight:600">Environment</td>
                  <td style="padding:9px 14px;color:#222">ubuntu-latest &nbsp;&middot;&nbsp; Java 21 &nbsp;&middot;&nbsp; Allure</td>
                </tr>
              </table>
              <!-- Test stats -->
              <h2 style="margin:0 0 14px;font-size:17px;color:#1a237e">Test Summary</h2>
              <table width="100%" cellpadding="6" cellspacing="6" style="margin-bottom:12px">
                <tr>
                  <td style="background:#e8f5e9;border-radius:8px;padding:14px;text-align:center">
                    <p style="margin:0;font-size:26px;font-weight:700;color:#2e7d32">{passed}</p>
                    <p style="margin:4px 0 0;font-size:11px;color:#555;text-transform:uppercase;letter-spacing:.5px">Passed</p>
                  </td>
                  <td style="background:#ffebee;border-radius:8px;padding:14px;text-align:center">
                    <p style="margin:0;font-size:26px;font-weight:700;color:#b71c1c">{failed}</p>
                    <p style="margin:4px 0 0;font-size:11px;color:#555;text-transform:uppercase;letter-spacing:.5px">Failed</p>
                  </td>
                  <td style="background:#fff8e1;border-radius:8px;padding:14px;text-align:center">
                    <p style="margin:0;font-size:26px;font-weight:700;color:#f57f17">{skipped}</p>
                    <p style="margin:4px 0 0;font-size:11px;color:#555;text-transform:uppercase;letter-spacing:.5px">Skipped</p>
                  </td>
                  <td style="background:#f5f5f5;border-radius:8px;padding:14px;text-align:center">
                    <p style="margin:0;font-size:26px;font-weight:700;color:#333">{total}</p>
                    <p style="margin:4px 0 0;font-size:11px;color:#555;text-transform:uppercase;letter-spacing:.5px">Total</p>
                  </td>
                </tr>
              </table>
              <!-- Pass rate bar -->
              <p style="margin:4px 0 6px;font-size:13px;color:#555">Pass rate: <strong>{pass_pct}%</strong></p>
              <div style="background:#e0e0e0;border-radius:99px;height:10px;margin-bottom:28px">
                <div style="background:{s_color};width:{pass_pct}%;height:10px;border-radius:99px;min-width:4px"></div>
              </div>
              {fail_block}
              <!-- Next steps -->
              <h2 style="margin:32px 0 12px;font-size:17px;color:#1a237e">Next Steps</h2>
              <div style="background:#f5f7ff;border-radius:8px;padding:16px 20px;font-size:13px;color:#333;line-height:1.8">
                {next_steps}
              </div>
              <!-- CTA buttons -->
              <div style="text-align:center;margin-top:32px">
                <a href="{run_url}"
                   style="display:inline-block;background:#1a237e;color:#fff;text-decoration:none;
                          padding:14px 28px;border-radius:6px;font-size:14px;font-weight:700;margin:5px">
                  View Run on GitHub &rarr;
                </a>
                <a href="{run_url}#artifacts"
                   style="display:inline-block;background:#3949ab;color:#fff;text-decoration:none;
                          padding:14px 28px;border-radius:6px;font-size:14px;font-weight:700;margin:5px">
                  Download Allure Report &darr;
                </a>
              </div>
            </td></tr>
            <!-- Footer -->
            <tr><td style="background:#f5f7ff;border-radius:0 0 10px 10px;padding:16px 36px;
                           text-align:center;border-top:1px solid #e8eaf0">
              <p style="margin:0;font-size:11px;color:#9e9e9e">
                This report was generated automatically by the Newsletter CI pipeline.<br>
                <a href="${{ github.server_url }}/${{ github.repository }}" style="color:#3949ab;text-decoration:none">${{ github.repository }}</a>
              </p>
            </td></tr>
          </table></td></tr></table>
          </body></html>"""
          subject = f"{s_icon} [Run #${run_num}] Newsletter Tests {status} ‚Äî {branch}"
          msg = MIMEMultipart("alternative")
          msg["Subject"] = subject
          msg["From"]    = f"Newsletter CI <{gmail_user}>"
          msg["To"]      = report_to
          msg.attach(MIMEText(html, "html"))
          with smtplib.SMTP_SSL("smtp.gmail.com", 465) as server:
              server.login(gmail_user, gmail_pass)
              server.sendmail(gmail_user, report_to, msg.as_string())
          print(f"Detailed email sent to {report_to} with {len(failing_tests)} failure blocks.")
          PYEOF
      # 11. Slack notification
      - name: Send Slack report
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          python3 << 'PYEOF'
          import json, os, subprocess, sys, re
          from glob import glob
          webhook = os.environ.get("SLACK_WEBHOOK_URL", "")
          if not webhook:
              print("No SLACK_WEBHOOK_URL set ‚Äî skipping")
              sys.exit(0)
          # ‚îÄ‚îÄ Pull values injected by GitHub Actions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          total    = "${{ steps.parse-results.outputs.total }}"    or "0"
          passed   = "${{ steps.parse-results.outputs.passed }}"   or "0"
          failed   = "${{ steps.parse-results.outputs.failed }}"   or "0"
          skipped  = "${{ steps.parse-results.outputs.skipped }}"  or "0"
          pass_pct = "${{ steps.parse-results.outputs.pass_pct }}" or "0"
          outcome  = "${{ steps.run-tests.outcome }}"
          is_pass  = (outcome == "success" and int(failed) == 0)
          repo     = "${{ github.repository }}"
          branch   = "${{ github.ref_name }}"
          actor    = "${{ github.actor }}"
          run_num  = "${{ github.run_number }}"
          run_url  = "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          sha      = "${{ github.sha }}"[:7]
          commit_msg = "${{ github.event.head_commit.message }}"
          event = "${{ github.event_name }}"
          trigger = {
              "push":               "Push to branch",
              "pull_request":       "Pull Request #${{ github.event.pull_request.number }}",
              "workflow_dispatch":  "Manual trigger",
          }.get(event, event)
          # ‚îÄ‚îÄ Parse Allure JSON results for failing tests ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          failing_tests = []
          for json_file in sorted(glob("target/allure-results/*-result.json")):
              try:
                  with open(json_file, 'r', encoding='utf-8') as f:
                      data = json.load(f)
              except (json.JSONDecodeError, IOError):
                  continue
              if data.get("status") in ["failed", "broken"]:
                  # Extract labels for class name
                  labels = {l["name"]: l["value"] for l in data.get("labels", [])}
                  test_class = labels.get("testClass", "").split(".")[-1] or "Unknown"
          
                  # Extract steps
                  steps_list = []
                  for i, s in enumerate(data.get("steps", []), 1):
                      steps_list.append(f"{i}. {s.get('name', 'Step')}")
          
                  steps_str = "\n".join(steps_list) if steps_list else "1. See Allure report for detailed execution trace."
                  # Extract description (Allure often puts it in the 'description' field)
                  desc = data.get("description", "No description provided.")
          
                  # Separate impact if it was included in the description string
                  impact = "High: Test failure indicates a defect that needs immediate investigation."
                  if "**Impact:**" in desc:
                      parts = desc.split("**Impact:**")
                      desc = parts[0].strip()
                      impact = parts[1].strip()
                  # Severity mapping
                  severity = labels.get("severity", "normal").capitalize()
                  priority = "High" if severity in ["Blocker", "Critical"] else ("Medium" if severity == "Normal" else "Low")
                  # Check for screenshot attachments
                  has_screenshot = any("screenshot" in att.get("name", "").lower() for att in data.get("attachments", []))
                  screenshot_note = "üì∏ *Screenshot captured!* Find it in the *Allure Report* artifact below." if has_screenshot else "‚ö†Ô∏è No screenshot captured for this failure."
                  failing_tests.append({
                      "name":        data.get("name", data.get("fullName", "Unknown Test")),
                      "class":       test_class,
                      "desc":        desc,
                      "steps":       steps_str,
                      "expected":    data.get("statusDetails", {}).get("message", "N/A"),
                      "impact":      impact,
                      "priority":    priority,
                      "severity":    severity,
                      "screenshot":  screenshot_note
                  })
          # ‚îÄ‚îÄ Build the Slack failure blocks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          header_color = "#2e7d32" if is_pass else "#e01e5a"
          status_emoji = "‚úÖ" if is_pass else "‚ùå"
          status_label = "PASSED" if is_pass else "FAILED"
          failure_blocks = []
          for i, t in enumerate(failing_tests, 1):
              block_text = (
                  f"*Test Case {i}:* `{t['name']}`\n"
                  f"*Class:* `{t['class']}`\n\n"
                  f"*Description*\n{t['desc']}\n\n"
                  f"*Steps to Reproduce*\n{t['steps']}\n\n"
                  f"*Actual Result (Assertion)*\n```\n{t['expected'][:300]}\n```\n"
                  f"*Impact*\n{t['impact']}\n\n"
                  f"*Priority:* {t['priority']} ({t['severity']})\n"
                  f"{t['screenshot']}"
              )
              failure_blocks.append({
                  "type": "section",
                  "text": {"type": "mrkdwn", "text": block_text}
              })
              if i < len(failing_tests):
                  failure_blocks.append({"type": "divider"})
          # ‚îÄ‚îÄ Assemble the full Slack payload ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          header_block = {
              "type": "header",
              "text": {
                  "type": "plain_text",
                  "text": f"{status_emoji}  Newsletter CI ‚Äî Tests {status_label}",
                  "emoji": True
              }
          }
          summary_block = {
              "type": "section",
              "fields": [
                  {"type": "mrkdwn", "text": f"*Repository*\n{repo}"},
                  {"type": "mrkdwn", "text": f"*Branch*\n{branch}"},
                  {"type": "mrkdwn", "text": f"*Triggered by*\n{actor} ({trigger})"},
                  {"type": "mrkdwn", "text": f"*Commit*\n`{sha}` ‚Äî {commit_msg[:60]}"},
                  {"type": "mrkdwn", "text": f"*Run*\n<{run_url}|Run #{run_num}>"},
                  {"type": "mrkdwn", "text": f"*Environment*\nubuntu-latest ¬∑ Headless Chrome"},
              ]
          }
          stats_block = {
              "type": "section",
              "text": {
                  "type": "mrkdwn",
                  "text": (
                      f"*Test Summary*\n"
                      f"‚úÖ Passed: *{passed}*   "
                      f"‚ùå Failed: *{failed}*   "
                      f"‚è≠ Skipped: *{skipped}*   "
                      f"üìä Total: *{total}*   "
                      f"üìà Pass rate: *{pass_pct}%*"
                  )
              }
          }
          blocks = [header_block, {"type": "divider"}, summary_block, stats_block]
          if failing_tests:
              blocks.append({"type": "divider"})
              blocks.append({
                  "type": "section",
                  "text": {
                      "type": "mrkdwn",
                      "text": f":rotating_light: *{len(failing_tests)} Failing Test Case(s) ‚Äî Detailed Report*"
                  }
              })
              blocks.append({"type": "divider"})
              blocks.extend(failure_blocks)
          else:
              blocks.append({
                  "type": "section",
                  "text": {
                      "type": "mrkdwn",
                      "text": ":white_check_mark: All tests passed. No failures to report."
                  }
              })
          blocks.append({"type": "divider"})
          blocks.append({
              "type": "actions",
              "elements": [{
                  "type": "button",
                  "text": {"type": "plain_text", "text": "View Full Run on GitHub", "emoji": True},
                  "url": run_url,
                  "style": "primary"
              }]
          })
          payload = {
              "text": f"{status_emoji} Newsletter Tests {status_label} ‚Äî Run #{run_num}",
              "attachments": [{
                  "color": header_color,
                  "blocks": blocks
              }]
          }
          result = subprocess.run(
              ["curl", "-s", "-X", "POST", webhook,
               "-H", "Content-Type: application/json",
               "-d", json.dumps(payload)],
              capture_output=True, text=True
          )
          print(result.stdout)
          if result.returncode != 0:
              print("STDERR:", result.stderr, file=sys.stderr)
              sys.exit(result.returncode)
          print(f"Slack report sent ‚Äî {len(failing_tests)} failure(s) detailed.")
          PYEOF
      # 13. Fail the build if any tests actually failed
      - name: Fail build on test failures
        if: steps.run-tests.outcome == 'failure'
        run: exit 1